<!--pages/income/index.wxml-->
<view class="container {{themeClass}}">
  <!-- çŠ¶æ€å¡ç‰‡ -->
  <view class="status-card card">
    <view class="status-header">
      <view class="status-info">
        <view class="work-status {{incomeInfo.isTodayWorkday ? 'working' : 'resting'}}">
          {{incomeInfo.isTodayWorkday ? 'å·¥ä½œæ—¥' : 'ä¼‘æ¯æ—¥'}}
        </view>
      </view>
      <view class="mode-switch" bindtap="toggleIncomeMode">
        {{prefs.incomeMode === 'precise' ? 'ç²¾ç¡®æ¨¡å¼' : 'å¹³å‡æ¨¡å¼'}}
      </view>
    </view>
    <view class="work-progress">
        <view class="progress-header">
          <view class="progress-title">
            <text class="progress-icon">â°</text>
            <text class="progress-label">å·¥ä½œè¿›åº¦</text>
          </view>
          <view class="progress-right">
            <view class="current-time precise">{{currentTime}}</view>
            <view class="progress-percent">
              <text class="percent-number">{{calcView.workProgressPercent || 0}}</text>
              <text class="percent-symbol">%</text>
            </view>
          </view>
        </view>
      
      <view class="progress-container">
        <view class="progress-track">
          <view class="progress-fill" style="width: {{calcView.workProgressPercent || 0}}%">
            <view class="progress-shine"></view>
            <view class="progress-glow"></view>
          </view>
          <view class="progress-markers">
            <view class="marker" style="left: 25%"></view>
            <view class="marker" style="left: 50%"></view>
            <view class="marker" style="left: 75%"></view>
          </view>
        </view>
      </view>
      
      <view class="progress-details">
        <view class="time-range">
          <text class="time-icon">ğŸ•</text>
          <text class="time-text">{{workTimeRange}}</text>
        </view>
        <view class="work-stats">
          <view class="stat-item">
            <text class="stat-label">å·²å·¥ä½œ</text>
            <text class="stat-value">{{calcView.currentWorkHours || 0}}h {{calcView.currentWorkMinutes || 0}}m</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æ”¶ç›Šå±•ç¤º -->
  <view class="income-display card">
    <view class="income-main">
      <view class="income-label">ä»Šæ—¥å·²èµš</view>
      <view class="income-amount {{animationClass}}">
        <text class="currency">Â¥</text>
        <text class="amount">{{incomeInfo.todayEarned}}</text>
      </view>
    </view>
    <view class="income-details">
      <view class="detail-row">
          <view class="detail-item">
            <view class="detail-label">æ¯åˆ†é’Ÿèµšå–</view>
            <view class="detail-value">Â¥{{calcView.incomePerMinuteFixed2}}</view>
          </view>
        <view class="detail-item">
          <view class="detail-label">ä»Šæ—¥æ€»è®¡</view>
          <view class="detail-value">Â¥{{incomeInfo.totalTodayIncome}}</view>
        </view>
      </view>
      <view class="detail-row">
        <view class="detail-item">
          <view class="detail-label">å‰©ä½™å¯èµš</view>
          <view class="detail-value">Â¥{{incomeInfo.remainingTodayIncome}}</view>
        </view>
        <view class="detail-item">
          <view class="detail-label">æœˆå·¥èµ„</view>
          <view class="detail-value">Â¥{{prefs.monthlySalary || 0}}</view>
        </view>
      </view>
    </view>
  </view>

  <!-- è®¡ç®—è¯¦æƒ… -->
  <view class="calculation-card card">
    <view class="card-title">è®¡ç®—è¯¦æƒ…</view>
    <view class="calc-section">
      <view class="calc-title">æ—¶é—´ç»Ÿè®¡</view>
      <view class="calc-items">
        <view class="calc-item">
          <text class="calc-label">å·²å·¥ä½œæ—¶é•¿</text>
          <text class="calc-value">{{calcView.currentWorkHours}}å°æ—¶{{calcView.currentWorkMinutes}}åˆ†é’Ÿ</text>
        </view>
        <view class="calc-item">
          <text class="calc-label">å‰©ä½™å·¥ä½œæ—¶é•¿</text>
          <text class="calc-value">{{calcView.remainingWorkHours}}å°æ—¶{{calcView.remainingWorkMinutes}}åˆ†é’Ÿ</text>
        </view>
        <view class="calc-item">
          <text class="calc-label">æ—¥å·¥ä½œæ—¶é•¿</text>
          <text class="calc-value">{{calcView.workHoursPerDay}}å°æ—¶</text>
        </view>
        <view class="calc-item" wx:if="{{prefs.incomeMode === 'precise'}}">
          <text class="calc-label">æœ¬æœˆå·¥ä½œæ—¶é•¿</text>
          <text class="calc-value">{{calcView.monthWorkHours}}å°æ—¶</text>
        </view>
      </view>
    </view>
    <view class="calc-section">
      <view class="calc-title">å·¥ä½œè®¾ç½®</view>
      <view class="calc-items">
        <view class="calc-item">
          <text class="calc-label">å·¥ä½œæ—¶é—´</text>
          <text class="calc-value">{{workTimeRange}}</text>
        </view>
        <view class="calc-item">
          <text class="calc-label">æœˆå·¥ä½œæ—¥</text>
          <text class="calc-value">{{monthWorkdaysDisplay || (prefs.workDaysPerMonth || 22)}}å¤©</text>
        </view>
        <view class="calc-item">
          <text class="calc-label">è®¡ç®—æ¨¡å¼</text>
          <text class="calc-value">{{prefs.incomeMode === 'precise' ? 'ç²¾ç¡®æ¨¡å¼' : 'å¹³å‡æ¨¡å¼'}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’® -->
  <view class="action-buttons">
    <view class="action-btn secondary" bindtap="refreshData">
      <text class="btn-icon">ğŸ”„</text>
      <text class="btn-text">åˆ·æ–°</text>
    </view>
    <view class="action-btn warning" bindtap="toggleOvertimeToday">
      <text class="btn-icon">ğŸ› ï¸</text>
      <text class="btn-text">ä¼‘æ¯æ—¥åŠ ç­</text>
    </view>
    <view class="action-btn primary" bindtap="showSettingsPanel">
      <text class="btn-icon">âš™ï¸</text>
      <text class="btn-text">è®¾ç½®</text>
    </view>
    <view class="action-btn success" bindtap="shareIncome">
      <text class="btn-icon">ğŸ“‹</text>
      <text class="btn-text">å¤åˆ¶</text>
    </view>
    <view class="action-btn info" bindtap="viewStatistics">
      <text class="btn-icon">ğŸ“Š</text>
      <text class="btn-text">ç»Ÿè®¡</text>
    </view>
  </view>

  <!-- è®¾ç½®é¢æ¿ -->
  <view class="settings-panel {{showSettings ? 'show' : ''}}" bindtap="hideSettingsPanel">
    <view class="settings-content" catchtap="stopPropagation">
      <view class="settings-header">
        <view class="settings-title">æ”¶ç›Šè®¾ç½®</view>
        <view class="close-btn" bindtap="hideSettingsPanel">Ã—</view>
      </view>
      <scroll-view scroll-y class="settings-body">
        <view class="setting-section">
          <view class="section-title">åŸºç¡€è®¾ç½®</view>
          <view class="setting-item">
            <text class="setting-label">æœˆå·¥èµ„</text>
            <input class="setting-input" 
                   type="number" 
                   placeholder="è¯·è¾“å…¥æœˆå·¥èµ„" 
                   value="{{tempPrefs.monthlySalary}}"
                   data-field="monthlySalary"
                   bindinput="onTempPrefChange"
                   confirm-type="done" />
          </view>
          <view class="setting-item">
            <text class="setting-label">ä¸Šç­æ—¶é—´</text>
            <picker mode="time" 
                    value="{{tempPrefs.workStartTime}}"
                    data-field="workStartTime"
                    bindchange="onTimeChange">
              <view class="picker-display">{{tempPrefs.workStartTime || '09:00'}}</view>
            </picker>
          </view>
          <view class="setting-item">
            <text class="setting-label">ä¸‹ç­æ—¶é—´</text>
            <picker mode="time" 
                    value="{{tempPrefs.workEndTime}}"
                    data-field="workEndTime"
                    bindchange="onTimeChange">
              <view class="picker-display">{{tempPrefs.workEndTime || '18:00'}}</view>
            </picker>
          </view>
          <view class="setting-item">
            <text class="setting-label">æ¯å‘¨ä¸Šç­å¤©æ•°</text>
            <picker range="{{workDaysPerWeekRange}}"
                    value="{{getWorkDaysPerWeekIndex(tempPrefs.workDaysPerWeek)}}"
                    data-field="workDaysPerWeek"
                    data-options="{{workDaysPerWeekOptions}}"
                    bindchange="onPickerChange">
              <view class="picker-display">{{getWorkDaysPerWeekLabel(tempPrefs.workDaysPerWeek)}}</view>
            </picker>
          </view>
        </view>
        <view class="setting-section">
          <view class="section-title">è®¡ç®—æ¨¡å¼</view>
          <view class="setting-item">
            <text class="setting-label">æ”¶ç›Šè®¡ç®—</text>
            <picker range="{{incomeModeRange}}"
                    value="{{prefs.incomeMode === 'precise' ? 1 : 0}}"
                    data-field="incomeMode"
                    data-options="{{incomeModeOptions}}"
                    bindchange="onPickerChange">
              <view class="picker-display">{{prefs.incomeMode === 'precise' ? 'ç²¾ç¡®æ¨¡å¼' : 'å¹³å‡æ¨¡å¼'}}</view>
            </picker>
          </view>
        </view>
        <view class="setting-section">
          <view class="section-title">åŠ¨æ•ˆè®¾ç½®</view>
          <view class="setting-item">
            <view class="setting-label">å¼€å¯åŠ¨æ•ˆ</view>
            <switch checked="{{tempPrefs.enableIncomeAnimation}}"
                    data-field="enableIncomeAnimation"
                    bindchange="onSwitchChange" />
          </view>
          <view class="setting-item" wx:if="{{tempPrefs.enableIncomeAnimation}}">
            <text class="setting-label">åŠ¨æ•ˆç±»å‹</text>
            <picker range="{{animationTypeRangeLabels}}"
                    value="{{tempPrefs.animationType === 'glow' ? 1 : tempPrefs.animationType === 'shake' ? 2 : tempPrefs.animationType === 'blink' ? 3 : tempPrefs.animationType === 'odometer' ? 4 : 0}}"
                    data-field="animationType"
                    data-options="{{animationTypeOptions}}"
                    bindchange="onPickerChange">
              <view class="picker-display">
                {{tempPrefs.animationType === 'glow' ? 'å‘å…‰' : tempPrefs.animationType === 'shake' ? 'æ‘‡æ™ƒ' : tempPrefs.animationType === 'blink' ? 'é—ªçƒ' : tempPrefs.animationType === 'odometer' ? 'é‡Œç¨‹è¡¨' : 'è„‰å†²'}}
              </view>
            </picker>
          </view>
          <view class="setting-item" wx:if="{{tempPrefs.enableIncomeAnimation && tempPrefs.animationType !== 'odometer'}}">
            <text class="setting-label">åŠ¨ç”»æ—¶é•¿: {{tempPrefs.animationDuration || 1000}}ms</text>
            <slider value="{{tempPrefs.animationDuration || 1000}}"
                    min="500"
                    max="3000"
                    step="100"
                    data-field="animationDuration"
                    bindchange="onSliderChange" />
          </view>
        </view>
      </scroll-view>
      <view class="settings-footer">
        <view class="setting-btn secondary" bindtap="hideSettingsPanel">å–æ¶ˆ</view>
        <view class="setting-btn primary" bindtap="saveSettings">ä¿å­˜</view>
      </view>
    </view>
  </view>
</view>
