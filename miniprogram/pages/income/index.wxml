<!--pages/income/index.wxml-->
<view class="container {{themeClass}}">
  <!-- 状态卡片 -->
  <view class="status-card card">
    <view class="status-header">
      <view class="status-info">
        <view class="work-status {{incomeInfo.isTodayWorkday ? 'working' : 'resting'}}">
          {{incomeInfo.isTodayWorkday ? '工作日' : '休息日'}}
        </view>
      </view>
      <view class="mode-switch" bindtap="toggleIncomeMode">
        {{prefs.incomeMode === 'precise' ? '精确模式' : '平均模式'}}
      </view>
    </view>
    <view class="work-progress">
        <view class="progress-header">
          <view class="progress-title">
            <text class="progress-icon">⏰</text>
            <text class="progress-label">工作进度</text>
          </view>
          <view class="progress-right">
            <view class="current-time precise">{{currentTime}}</view>
            <view class="progress-percent">
              <text class="percent-number">{{calcView.workProgressPercent || 0}}</text>
              <text class="percent-symbol">%</text>
            </view>
          </view>
        </view>
      
      <view class="progress-container">
        <view class="progress-track">
          <view class="progress-fill" style="width: {{calcView.workProgressPercent || 0}}%">
            <view class="progress-shine"></view>
            <view class="progress-glow"></view>
          </view>
          <view class="progress-markers">
            <view class="marker" style="left: 25%"></view>
            <view class="marker" style="left: 50%"></view>
            <view class="marker" style="left: 75%"></view>
          </view>
        </view>
      </view>
      
      <view class="progress-details">
        <view class="time-range">
          <text class="time-icon">🕐</text>
          <text class="time-text">{{workTimeRange}}</text>
        </view>
        <view class="work-stats">
          <view class="stat-item">
            <text class="stat-label">已工作</text>
            <text class="stat-value">{{calcView.currentWorkHours || 0}}h {{calcView.currentWorkMinutes || 0}}m</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 收益展示 -->
  <view class="income-display card">
    <view class="income-main">
      <view class="income-label">今日已赚</view>
      <view class="income-amount {{animationClass}}">
        <text class="currency">¥</text>
        <text class="amount">{{incomeInfo.todayEarned}}</text>
      </view>
    </view>
    <view class="income-details">
      <view class="detail-row">
          <view class="detail-item">
            <view class="detail-label">每分钟赚取</view>
            <view class="detail-value">¥{{calcView.incomePerMinuteFixed2}}</view>
          </view>
        <view class="detail-item">
          <view class="detail-label">今日总计</view>
          <view class="detail-value">¥{{incomeInfo.totalTodayIncome}}</view>
        </view>
      </view>
      <view class="detail-row">
        <view class="detail-item">
          <view class="detail-label">剩余可赚</view>
          <view class="detail-value">¥{{incomeInfo.remainingTodayIncome}}</view>
        </view>
        <view class="detail-item">
          <view class="detail-label">月工资</view>
          <view class="detail-value">¥{{prefs.monthlySalary || 0}}</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 计算详情 -->
  <view class="calculation-card card">
    <view class="card-title">计算详情</view>
    <view class="calc-section">
      <view class="calc-title">时间统计</view>
      <view class="calc-items">
        <view class="calc-item">
          <text class="calc-label">已工作时长</text>
          <text class="calc-value">{{calcView.currentWorkHours}}小时{{calcView.currentWorkMinutes}}分钟</text>
        </view>
        <view class="calc-item">
          <text class="calc-label">剩余工作时长</text>
          <text class="calc-value">{{calcView.remainingWorkHours}}小时{{calcView.remainingWorkMinutes}}分钟</text>
        </view>
        <view class="calc-item">
          <text class="calc-label">日工作时长</text>
          <text class="calc-value">{{calcView.workHoursPerDay}}小时</text>
        </view>
        <view class="calc-item" wx:if="{{prefs.incomeMode === 'precise'}}">
          <text class="calc-label">本月工作时长</text>
          <text class="calc-value">{{calcView.monthWorkHours}}小时</text>
        </view>
      </view>
    </view>
    <view class="calc-section">
      <view class="calc-title">工作设置</view>
      <view class="calc-items">
        <view class="calc-item">
          <text class="calc-label">工作时间</text>
          <text class="calc-value">{{workTimeRange}}</text>
        </view>
        <view class="calc-item">
          <text class="calc-label">月工作日</text>
          <text class="calc-value">{{monthWorkdaysDisplay || (prefs.workDaysPerMonth || 22)}}天</text>
        </view>
        <view class="calc-item">
          <text class="calc-label">计算模式</text>
          <text class="calc-value">{{prefs.incomeMode === 'precise' ? '精确模式' : '平均模式'}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 操作按钮 -->
  <view class="action-buttons">
    <view class="action-btn secondary" bindtap="refreshData">
      <text class="btn-icon">🔄</text>
      <text class="btn-text">刷新</text>
    </view>
    <view class="action-btn warning" bindtap="toggleOvertimeToday">
      <text class="btn-icon">🛠️</text>
      <text class="btn-text">休息日加班</text>
    </view>
    <view class="action-btn primary" bindtap="showSettingsPanel">
      <text class="btn-icon">⚙️</text>
      <text class="btn-text">设置</text>
    </view>
    <view class="action-btn success" bindtap="shareIncome">
      <text class="btn-icon">📋</text>
      <text class="btn-text">复制</text>
    </view>
    <view class="action-btn info" bindtap="viewStatistics">
      <text class="btn-icon">📊</text>
      <text class="btn-text">统计</text>
    </view>
  </view>

  <!-- 设置面板 -->
  <view class="settings-panel {{showSettings ? 'show' : ''}}" bindtap="hideSettingsPanel">
    <view class="settings-content" catchtap="stopPropagation">
      <view class="settings-header">
        <view class="settings-title">收益设置</view>
        <view class="close-btn" bindtap="hideSettingsPanel">×</view>
      </view>
      <scroll-view scroll-y class="settings-body">
        <view class="setting-section">
          <view class="section-title">基础设置</view>
          <view class="setting-item">
            <text class="setting-label">月工资</text>
            <input class="setting-input" 
                   type="number" 
                   placeholder="请输入月工资" 
                   value="{{tempPrefs.monthlySalary}}"
                   data-field="monthlySalary"
                   bindinput="onTempPrefChange"
                   confirm-type="done" />
          </view>
          <view class="setting-item">
            <text class="setting-label">上班时间</text>
            <picker mode="time" 
                    value="{{tempPrefs.workStartTime}}"
                    data-field="workStartTime"
                    bindchange="onTimeChange">
              <view class="picker-display">{{tempPrefs.workStartTime || '09:00'}}</view>
            </picker>
          </view>
          <view class="setting-item">
            <text class="setting-label">下班时间</text>
            <picker mode="time" 
                    value="{{tempPrefs.workEndTime}}"
                    data-field="workEndTime"
                    bindchange="onTimeChange">
              <view class="picker-display">{{tempPrefs.workEndTime || '18:00'}}</view>
            </picker>
          </view>
          <view class="setting-item">
            <text class="setting-label">每周上班天数</text>
            <picker range="{{workDaysPerWeekRange}}"
                    value="{{getWorkDaysPerWeekIndex(tempPrefs.workDaysPerWeek)}}"
                    data-field="workDaysPerWeek"
                    data-options="{{workDaysPerWeekOptions}}"
                    bindchange="onPickerChange">
              <view class="picker-display">{{getWorkDaysPerWeekLabel(tempPrefs.workDaysPerWeek)}}</view>
            </picker>
          </view>
        </view>
        <view class="setting-section">
          <view class="section-title">计算模式</view>
          <view class="setting-item">
            <text class="setting-label">收益计算</text>
            <picker range="{{incomeModeRange}}"
                    value="{{prefs.incomeMode === 'precise' ? 1 : 0}}"
                    data-field="incomeMode"
                    data-options="{{incomeModeOptions}}"
                    bindchange="onPickerChange">
              <view class="picker-display">{{prefs.incomeMode === 'precise' ? '精确模式' : '平均模式'}}</view>
            </picker>
          </view>
        </view>
        <view class="setting-section">
          <view class="section-title">动效设置</view>
          <view class="setting-item">
            <view class="setting-label">开启动效</view>
            <switch checked="{{tempPrefs.enableIncomeAnimation}}"
                    data-field="enableIncomeAnimation"
                    bindchange="onSwitchChange" />
          </view>
          <view class="setting-item" wx:if="{{tempPrefs.enableIncomeAnimation}}">
            <text class="setting-label">动效类型</text>
            <picker range="{{animationTypeRangeLabels}}"
                    value="{{tempPrefs.animationType === 'glow' ? 1 : tempPrefs.animationType === 'shake' ? 2 : tempPrefs.animationType === 'blink' ? 3 : tempPrefs.animationType === 'odometer' ? 4 : 0}}"
                    data-field="animationType"
                    data-options="{{animationTypeOptions}}"
                    bindchange="onPickerChange">
              <view class="picker-display">
                {{tempPrefs.animationType === 'glow' ? '发光' : tempPrefs.animationType === 'shake' ? '摇晃' : tempPrefs.animationType === 'blink' ? '闪烁' : tempPrefs.animationType === 'odometer' ? '里程表' : '脉冲'}}
              </view>
            </picker>
          </view>
          <view class="setting-item" wx:if="{{tempPrefs.enableIncomeAnimation && tempPrefs.animationType !== 'odometer'}}">
            <text class="setting-label">动画时长: {{tempPrefs.animationDuration || 1000}}ms</text>
            <slider value="{{tempPrefs.animationDuration || 1000}}"
                    min="500"
                    max="3000"
                    step="100"
                    data-field="animationDuration"
                    bindchange="onSliderChange" />
          </view>
        </view>
      </scroll-view>
      <view class="settings-footer">
        <view class="setting-btn secondary" bindtap="hideSettingsPanel">取消</view>
        <view class="setting-btn primary" bindtap="saveSettings">保存</view>
      </view>
    </view>
  </view>
</view>
